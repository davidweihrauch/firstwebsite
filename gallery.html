
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gallery</title>
<style>
  :root {
    --gap: 10px;
    --radius: 10px;
    --bg: #0b0d0f; --card: #14171a; --text: #e8eaed;
    --accent: #248a3d;
    --header-sticky-bg: #0b0d0fF2;
  }
  * { box-sizing: border-box; }
  body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial, sans-serif;
         background: var(--bg); color: var(--text); }
  header { padding: 20px; text-align: center; }
  a { color: var(--accent); text-decoration: none; }
  a:hover { text-decoration: underline; }

  .week { max-width: 1200px; margin: 0 auto 38px; padding: 0 10px; }
  .week-title {
    position: sticky; top: 0; z-index: 5;
    margin: 0 0 8px; padding: 10px 6px;
    font-size: 16px; font-weight: 600; letter-spacing: 0.2px;
    background: var(--header-sticky-bg); backdrop-filter: blur(6px);
    border-bottom: 1px solid #1f2429;
  }

  .gallery { display: flex; flex-wrap: wrap; gap: 10px; padding: 0; }
  .gallery figure {
    margin: 0; border-radius: var(--radius); background: var(--card);
    overflow: hidden; box-shadow: 0 6px 20px rgba(0,0,0,.25);
    display: flex; align-items: center; justify-content: center;
  }
  .gallery figure > img {
    height: 200px; width: auto; display: block; object-fit: contain;
    transition: transform .25s ease, opacity .25s ease;
  }
  .gallery figure:hover > img { transform: scale(1.02); opacity: .98; }
  @media (min-width:768px){ .gallery figure > img { height: 220px; } }
  @media (min-width:1024px){ .gallery figure > img { height: 240px; } }

  .lightbox { position: fixed; inset: 0; display:none; align-items:center; justify-content:center;
              background: rgba(0,0,0,.92); padding:2vw; z-index: 9999; }
  .lightbox.open { display:flex; }
  .lightbox img { max-width: min(95vw, 1600px); max-height: 95vh; border-radius: var(--radius);
                  box-shadow: 0 20px 60px rgba(0,0,0,.5); }
  .lightbox button.close { position:absolute; top:10px; right:10px; border:0; background: rgba(255,255,255,.15);
                           color:#fff; padding:8px 12px; border-radius:8px; cursor:pointer; }

  .status { max-width: 1200px; margin: 0 auto; padding: 0 10px 16px; opacity: .7; font-size: 14px; }
</style>
</head>
<body>
  <header>
    <h1>Gallerie</h1>
    <a href="./index.html">← Back to home</a>
    <p style="opacity:.7">Zum Vergrößern auf die Fotos klicken.</p>
  </header>

  <main id="weeks" aria-live="polite"></main>
  <div class="status" id="status"></div>

  <div class="lightbox" id="lightbox" role="dialog" aria-modal="true" aria-label="Image viewer">
    <button class="close" type="button" aria-label="Close">Close ✕</button>
    <img id="lightboxImg" alt="">
  </div>

<script>
(async function () {
  const weeksRoot = document.getElementById('weeks');
  const statusEl  = document.getElementById('status');
  const lightbox  = document.getElementById('lightbox');
  const lightImg  = document.getElementById('lightboxImg');
  const closeBtn  = lightbox.querySelector('button.close');

  statusEl.textContent = 'Lade Galerie-Daten …';
  const res = await fetch('./gallery.json', { cache: 'no-cache' });
  if (!res.ok) {
    weeksRoot.innerHTML = '<p style="opacity:.7">Could not load gallery.json.</p>';
    return;
  }
  /** @type {{src:string, takenAt:string|null}[]} */
  const items = await res.json();

  const meta = items.map((it, index) => ({
    url: it.src,
    takenAt: it.takenAt ? new Date(it.takenAt) : null,
    index
  }));

  // Sort newest first
  meta.sort((a, b) => {
    if (a.takenAt && b.takenAt) return b.takenAt - a.takenAt || a.index - b.index;
    if (a.takenAt) return -1;
    if (b.takenAt) return 1;
    return a.index - b.index;
  });

  // ISO week helpers (local time)
  function startOfISOWeekLocal(d) {
    const dt = new Date(d); dt.setHours(0,0,0,0);
    const day = (dt.getDay() + 6) % 7; // Mon=0..Sun=6
    dt.setDate(dt.getDate() - day);
    return dt;
  }
  function endOfISOWeekLocal(d) {
    const s = startOfISOWeekLocal(d);
    const e = new Date(s); e.setDate(s.getDate() + 6); e.setHours(23,59,59,999);
    return e;
  }
  function isoWeekYearAndNumber(d) {
    const dt = new Date(d); dt.setHours(0,0,0,0);
    const day = (dt.getDay() + 6) % 7;
    const th = new Date(dt); th.setDate(dt.getDate() + (3 - day));
    const year = th.getFullYear();
    const jan4 = new Date(year, 0, 4);
    const jan4Day = (jan4.getDay() + 6) % 7;
    const start = new Date(jan4); start.setDate(jan4.getDate() - jan4Day);
    const week = Math.floor((dt - start) / 86400000 / 7) + 1;
    return { year, week };
  }
  function weekKey(d) {
    if (!d) return 'unknown';
    const { year, week } = isoWeekYearAndNumber(d);
    return `${year}-W${String(week).padStart(2,'0')}`;
  }
  function fmtWeekTitle(d) {
    const { year, week } = isoWeekYearAndNumber(d);
    const s = startOfISOWeekLocal(d);
    const e = endOfISOWeekLocal(d);
    const fmt = x => x.toLocaleDateString(undefined, { day:'2-digit', month:'short' });
    return { label: `Week ${year}-W${String(week).padStart(2,'0')} · ${fmt(s)} – ${fmt(e)}`, start:s };
  }

  // Group by week
  const groups = new Map();
  for (const m of meta) {
    const key = weekKey(m.takenAt);
    if (!groups.has(key)) {
      let title = 'Unknown week';
      let sortKey = -Infinity;
      if (m.takenAt) {
        const info = fmtWeekTitle(m.takenAt);
        title = info.label;
        sortKey = +info.start;
      }
      groups.set(key, { title, sortKey, items: [] });
    }
    groups.get(key).items.push(m);
  }

  // Sort groups by week start DESC; unknown last
  const sortedGroups = [...groups.entries()]
    .sort((a, b) => {
      if (a[0] === 'unknown') return 1;
      if (b[0] === 'unknown') return -1;
      return b[1].sortKey - a[1].sortKey;
    })
    .map(([_, v]) => v);

  // Render
  weeksRoot.innerHTML = '';
  for (const group of sortedGroups) {
    const section = document.createElement('section');
    section.className = 'week';

    const h2 = document.createElement('h2');
    h2.className = 'week-title';
    h2.textContent = group.title;
    section.appendChild(h2);

    const grid = document.createElement('div');
    grid.className = 'gallery';

    // Newest first within week
    group.items.sort((a, b) => {
      if (a.takenAt && b.takenAt) return b.takenAt - a.takenAt || a.index - b.index;
      if (a.takenAt) return -1;
      if (b.takenAt) return 1;
      return a.index - b.index;
    });

    for (const { url } of group.items) {
      const fig = document.createElement('figure');
      fig.dataset.full = url;

      const img = document.createElement('img');
      img.src = url;
      img.loading = 'lazy';
      img.decoding = 'async';
      img.alt = url.split('/').pop().replace(/\.[^.]+$/, '').replace(/[-_]/g, ' ');

      fig.appendChild(img);
      fig.addEventListener('click', () => openLightbox(url, img.alt));
      grid.appendChild(fig);
    }

    section.appendChild(grid);
    weeksRoot.appendChild(section);
  }

  statusEl.textContent = '';

  function openLightbox(src, alt) {
    lightImg.src = src;
    lightImg.alt = alt || '';
    lightbox.classList.add('open');
    document.body.style.overflow = 'hidden';
  }
  function closeLightbox() {
    lightbox.classList.remove('open');
    lightImg.src = '';
    document.body.style.overflow = '';
  }
  closeBtn.addEventListener('click', closeLightbox);
  lightbox.addEventListener('click', (e)=>{ if (e.target === lightbox) closeLightbox(); });
  window.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') closeLightbox(); });
})();
</script>
</body>
</html>
